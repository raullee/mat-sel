// ============================================
// MatSelamat.com - Production-Ready AI Prompts
// Optimized for Claude Sonnet 4 API
// ============================================

const SYSTEM_PROMPTS = {
  
  // ============================================
  // 1. NARRATIVE REFINEMENT (Magic Wand Feature)
  // ============================================
  narrativeRefinement: {
    system: `Anda adalah pembantu penulisan undang-undang Malaysia yang pakar dalam prosedur tuntutan kecil di bawah Perintah 93 Kaedah-Kaedah Mahkamah 2012.

OBJEKTIF: Tukar keterangan tidak formal pengguna menjadi Kenyataan Tuntutan yang formal dan sesuai untuk Mahkamah bagi Borang 198.

PRINSIP PENULISAN:
1. Gunakan Bahasa Melayu formal tetapi mudah difahami
2. Struktur kronologi yang jelas (tarikh penting, peristiwa, tindakan)
3. Rujuk bukti dengan spesifik (contoh: "sebagaimana terkandung dalam lampiran WhatsApp bertarikh 15 Mac 2025")
4. Elakkan bahasa emosi atau subjektif
5. Fokus pada fakta dan kewajipan kontraktual
6. Gunakan istilah undang-undang yang betul tetapi tidak berlebihan
7. Hadkan kepada 250-350 perkataan

FORMAT OUTPUT:
Berikan hanya naratif kenyataan tuntutan, tanpa tajuk atau pengenalan. Mulakan terus dengan "Pada [tarikh]..." atau "Plaintif dan Defendan telah..."`,

    userPrompt: (data) => `MAKLUMAT TUNTUTAN:
- Plaintif: ${data.claimantName}
- Defendan: ${data.defendantName}
- Amaun Tuntutan: RM${data.claimAmount}
- Jenis Tuntutan: ${getClaimTypeInMalay(data.claimType)}
- Bukti Yang Ada: ${data.evidenceList || 'Kontrak, invois, mesej WhatsApp'}

KETERANGAN ASAL PENGGUNA:
"${data.rawDescription}"

ARAHAN:
Tulis Kenyataan Tuntutan yang profesional dalam Bahasa Melayu untuk Borang 198 Bahagian C. Pastikan ia memenuhi keperluan Mahkamah dan boleh difahami oleh Hakim.`,

    validate: (output) => {
      // Quality checks
      const checks = {
        lengthOk: output.length >= 500 && output.length <= 2000,
        hasDate: /\d{1,2}\s+(Januari|Februari|Mac|April|Mei|Jun|Julai|Ogos|September|Oktober|November|Disember)\s+\d{4}/i.test(output),
        hasAmount: output.includes(`RM${data.claimAmount}`),
        isFormal: !/(saya rasa|saya fikir|mungkin|rasanya)/i.test(output),
        noEmotional: !/(marah|sedih|kecewa|teruk|jahat)/i.test(output)
      };
      
      return Object.values(checks).every(v => v);
    }
  },

  // ============================================
  // 2. INTELLIGENT INTERVIEW SYSTEM
  // ============================================
  intelligentInterview: {
    system: `Anda adalah penemuduga AI yang membantu pengguna mengumpul maklumat penting untuk kes tuntutan kecil di Malaysia.

OBJEKTIF: Kumpul maklumat lengkap melalui soalan yang strategik dan efisien.

PRINSIP BERTANYA:
1. SATU soalan pada satu masa (jangan overwhelm)
2. Mulakan dengan soalan terbuka, kemudian spesifik
3. Maksimum 8 soalan keseluruhan
4. Sesuaikan soalan berdasarkan jawapan sebelumnya
5. Terangkan MENGAPA anda bertanya (transparency)
6. Gunakan bahasa yang mesra dan tidak formal
7. Simpati tetapi kekal profesional

MAKLUMAT PENTING UNTUK DIKUMPUL:
✓ Tarikh perjanjian/insiden
✓ Cara perjanjian dibuat (lisan/bertulis/WhatsApp)
✓ Jumlah yang dipersetujui
✓ Tarikh pembayaran sepatutnya
✓ Cubaan menuntut (notis, mesej, panggilan)
✓ Respons defendan (jika ada)
✓ Bukti yang ada (kontrak, invois, screenshot, saksi)
✓ Sebab fail tuntutan sekarang (last resort confirmation)

STRATEGI SOALAN:
- Q1-2: Konteks am (What happened? When?)
- Q3-4: Butiran perjanjian (Amount? Terms?)
- Q5-6: Bukti dan dokumentasi
- Q7-8: Cubaan penyelesaian dan justifikasi

FORMAT OUTPUT:
Berikan hanya soalan seterusnya, dalam bahasa pengguna (Malay atau English). Jangan ulang maklumat yang sudah dikumpul.`,

    userPrompt: (data) => `KONTEKS TUNTUTAN:
- Jenis: ${data.claimType}
- Amaun: RM${data.claimAmount}
- Defendan: ${data.defendantName}

SOALAN YANG SUDAH DITANYA: ${data.questionsAsked}/8

MAKLUMAT YANG SUDAH DIKUMPUL:
${JSON.stringify(data.gatheredInfo, null, 2)}

MAKLUMAT YANG MASIH DIPERLUKAN:
${JSON.stringify(data.missingInfo, null, 2)}

JAWAPAN PENGGUNA YANG TERAKHIR:
"${data.lastUserResponse}"

ARAHAN:
Buat soalan seterusnya yang paling penting untuk kes ini. Jika sudah cukup maklumat, beritahu pengguna bahawa temu bual selesai.`,

    questionPriority: [
      {
        key: 'agreementDate',
        question: (claimType) => `Bilakah anda dan ${defendantName} bersetuju mengenai pembayaran ini? Tarikh yang tepat penting untuk Mahkamah.`,
        importance: 10
      },
      {
        key: 'agreementMethod',
        question: () => `Bagaimana perjanjian ini dibuat? Ada kontrak bertulis, email, WhatsApp, atau hanya perbualan lisan?`,
        importance: 9
      },
      {
        key: 'paymentDueDate',
        question: () => `Bilakah pembayaran sepatutnya dibuat? Ada tarikh spesifik yang dipersetujui?`,
        importance: 9
      },
      {
        key: 'evidenceAvailable',
        question: () => `Bukti apa yang anda ada? Contoh: kontrak, invois, screenshot WhatsApp, email, saksi, dll.`,
        importance: 8
      },
      {
        key: 'collectionAttempts',
        question: () => `Apa yang anda sudah cuba lakukan untuk dapatkan bayaran? Hantar mesej reminder, notis, panggilan telefon?`,
        importance: 7
      },
      {
        key: 'defendantResponse',
        question: () => `Apa respons ${defendantName}? Dia mengaku hutang tetapi tak bayar, atau kata tak berhutang langsung?`,
        importance: 7
      }
    ]
  },

  // ============================================
  // 3. EVIDENCE ANALYSIS
  // ============================================
  evidenceAnalysis: {
    system: `Anda adalah penasihat undang-undang yang menilai kekuatan bukti untuk kes tuntutan kecil.

OBJEKTIF: Analisis bukti dan beri cadangan untuk perkuatkan kes.

KRITERIA BUKTI KUAT:
✓ Bertulis (lebih kuat dari lisan)
✓ Bertarikh (boleh verify timeline)
✓ Ditandatangani (jika kontrak)
✓ Pelbagai sumber (WhatsApp + email + invois)
✓ Konsisten (semua bukti sama cerita)

KRITERIA BUKTI LEMAH:
✗ Hanya lisan, tiada dokumentasi
✗ Tidak konsisten (bukti bercanggah)
✗ Tidak lengkap (missing critical info)
✗ Boleh disangkal mudah oleh defendan

OUTPUT:
1. Skor kekuatan (1-10)
2. Bukti utama yang ada
3. Gap/kelemahan
4. Cadangan untuk perkuatkan kes`,

    userPrompt: (data) => `ANALISIS BUKTI INI:

Jenis Tuntutan: ${data.claimType}
Amaun: RM${data.claimAmount}

Bukti Yang Ada:
${data.evidenceList.map((e, i) => `${i+1}. ${e.type}: ${e.description}`).join('\n')}

Cerita Plaintif:
"${data.claimDescription}"

Berikan analisis kekuatan bukti dan cadangan penambahbaikan.`
  },

  // ============================================
  // 4. CLAIM TYPE CLASSIFICATION
  // ============================================
  claimClassification: {
    system: `Anda adalah pakar undang-undang yang mengklasifikasikan jenis tuntutan mengikut kategori Mahkamah Malaysia.

KATEGORI TUNTUTAN KECIL:
1. Hutang (Debt) - Wang yang dipinjam atau terhutang untuk barang/perkhidmatan
2. Pecah Kontrak (Breach of Contract) - Pihak lain tak ikut terma perjanjian
3. Kerosakan Harta (Damages) - Kerugian akibat negligence atau perbuatan lain
4. Penipuan (Fraud) - Penipuan atau misrepresentation
5. Lain-lain (Other) - Kes yang tak masuk kategori atas

ARAHAN:
Baca penerangan pengguna dan tentukan kategori yang paling sesuai. Terangkan kenapa kategori ini dipilih.`,

    userPrompt: (description) => `Klasifikasikan jenis tuntutan ini:

"${description}"

Berikan:
1. Kategori utama
2. Penjelasan ringkas (2-3 ayat)
3. Unsur-unsur undang-undang yang perlu dibuktikan`
  },

  // ============================================
  // 5. DEFENDANT ADDRESS VALIDATOR
  // ============================================
  addressValidator: {
    system: `Anda adalah validator alamat untuk keperluan Mahkamah.

OBJEKTIF: Pastikan alamat defendan lengkap dan sah untuk servis notis.

KEPERLUAN ALAMAT SAH:
✓ Nama/No rumah atau lot
✓ Nama jalan
✓ Taman/kawasan (jika ada)
✓ Poskod 5 digit
✓ Bandar/daerah
✓ Negeri

FORMAT STANDARD:
No. 123, Jalan Example 4/2,
Taman Sample,
50000 Kuala Lumpur,
Wilayah Persekutuan.

MASALAH BIASA:
- Tiada poskod
- Negeri tidak lengkap
- Format tidak standard
- Alamat terlalu samar

OUTPUT:
1. Status: SAH / TIDAK LENGKAP / PERLU PENAMBAHBAIKAN
2. Alamat yang telah diperbetulkan (jika perlu)
3. Elemen yang hilang (jika ada)`,

    userPrompt: (address) => `Validasi alamat ini:

"${address}"

Betulkan jika perlu dan pastikan mengikut format Mahkamah Malaysia.`
  }
};

// ============================================
// HELPER FUNCTIONS
// ============================================

function getClaimTypeInMalay(type) {
  const types = {
    'debt': 'Tuntutan Hutang',
    'contract': 'Pecah Kontrak',
    'damages': 'Tuntutan Ganti Rugi',
    'fraud': 'Penipuan',
    'other': 'Lain-lain'
  };
  return types[type] || 'Tuntutan Kecil';
}

// ============================================
// API CALL WRAPPER WITH ERROR HANDLING
// ============================================

async function callClaudeAPI(promptType, data) {
  const prompt = SYSTEM_PROMPTS[promptType];
  
  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': process.env.ANTHROPIC_API_KEY,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: promptType === 'narrativeRefinement' ? 2000 : 1000,
        system: prompt.system,
        messages: [{
          role: 'user',
          content: typeof prompt.userPrompt === 'function' 
            ? prompt.userPrompt(data) 
            : prompt.userPrompt
        }],
        temperature: 0.7, // Balance between creativity and consistency
      })
    });

    if (!response.ok) {
      throw new Error(`API call failed: ${response.status}`);
    }

    const result = await response.json();
    const output = result.content[0].text;

    // Validate output if validator exists
    if (prompt.validate && !prompt.validate(output)) {
      console.warn('AI output failed validation, retrying...');
      // Retry with more explicit instructions
      return callClaudeAPI(promptType, {
        ...data,
        retryAttempt: (data.retryAttempt || 0) + 1
      });
    }

    return {
      success: true,
      output: output,
      usage: {
        inputTokens: result.usage.input_tokens,
        outputTokens: result.usage.output_tokens,
        estimatedCost: calculateCost(result.usage)
      }
    };

  } catch (error) {
    console.error('AI API Error:', error);
    
    // Fallback to template-based generation if API fails
    if (promptType === 'narrativeRefinement') {
      return {
        success: false,
        fallback: generateTemplateNarrative(data),
        error: error.message
      };
    }
    
    throw error;
  }
}

// ============================================
// FALLBACK: TEMPLATE-BASED NARRATIVE
// ============================================

function generateTemplateNarrative(data) {
  const today = new Date().toLocaleDateString('ms-MY', {
    day: 'numeric',
    month: 'long',
    year: 'numeric'
  });
  
  const template = `Pada ${data.agreementDate || '[tarikh perjanjian]'}, Plaintif dan Defendan telah bersetuju bahawa Defendan akan membayar sejumlah RM${data.claimAmount} kepada Plaintif untuk ${getServiceDescription(data.claimType)}.

Perjanjian ini telah dibuat secara ${data.agreementMethod || 'bertulis dan/atau lisan'}, dan Defendan telah bersetuju untuk membayar jumlah tersebut pada atau sebelum ${data.paymentDueDate || '[tarikh pembayaran]'}.

Plaintif telah melaksanakan ${getObligationDescription(data.claimType)} dengan sempurna, namun Defendan telah gagal membayar jumlah yang dipersetujui.

Plaintif telah menghantar notis peringatan kepada Defendan pada ${data.reminderDate || '[tarikh notis]'}, namun Defendan masih gagal membayar sehingga ke hari ini.

Oleh yang demikian, Plaintif menuntut bayaran penuh berjumlah RM${data.claimAmount} beserta kos dan apa-apa bantuan lain yang difikirkan patut oleh Mahkamah.`;

  return template;
}

function getServiceDescription(type) {
  const services = {
    'debt': 'perkhidmatan/barang yang telah diberikan',
    'contract': 'perkhidmatan di bawah kontrak',
    'damages': 'kerugian yang dialami',
    'other': 'perkhidmatan yang telah diberikan'
  };
  return services[type] || 'perkhidmatan';
}

function getObligationDescription(type) {
  const obligations = {
    'debt': 'perkhidmatan yang dipersetujui',
    'contract': 'kewajipan kontraktual',
    'damages': 'tanggungjawab penjagaan',
    'other': 'kewajipan yang dipersetujui'
  };
  return obligations[type] || 'tanggungjawab';
}

// ============================================
// COST CALCULATION (Track API Spending)
// ============================================

function calculateCost(usage) {
  // Claude Sonnet 4 pricing (as of 2025)
  const INPUT_COST_PER_1M = 3.00;  // USD per 1M tokens
  const OUTPUT_COST_PER_1M = 15.00; // USD per 1M tokens
  const USD_TO_MYR = 4.70;
  
  const inputCost = (usage.input_tokens / 1000000) * INPUT_COST_PER_1M;
  const outputCost = (usage.output_tokens / 1000000) * OUTPUT_COST_PER_1M;
  const totalUSD = inputCost + outputCost;
  const totalMYR = totalUSD * USD_TO_MYR;
  
  return {
    usd: totalUSD.toFixed(4),
    myr: totalMYR.toFixed(2)
  };
}

// ============================================
// USAGE TRACKING & COST MONITORING
// ============================================

class AIUsageTracker {
  constructor() {
    this.dailyUsage = {
      calls: 0,
      tokens: 0,
      cost: 0
    };
    
    this.DAILY_BUDGET = 500; // RM500/day max
  }
  
  async track(usage) {
    this.dailyUsage.calls++;
    this.dailyUsage.tokens += usage.inputTokens + usage.outputTokens;
    this.dailyUsage.cost += parseFloat(usage.estimatedCost.myr);
    
    // Alert if approaching budget
    if (this.dailyUsage.cost > this.DAILY_BUDGET * 0.8) {
      await this.sendAlert('WARNING: 80% of daily AI budget used');
    }
    
    if (this.dailyUsage.cost > this.DAILY_BUDGET) {
      await this.sendAlert('CRITICAL: Daily AI budget exceeded');
      throw new Error('Daily AI budget exceeded. Please contact admin.');
    }
    
    // Log to database
    await this.logToDatabase(usage);
  }
  
  async sendAlert(message) {
    // Send email/SMS to admin
    console.error(message);
  }
  
  async logToDatabase(usage) {
    // Store in PostgreSQL for analytics
  }
  
  resetDaily() {
    this.dailyUsage = { calls: 0, tokens: 0, cost: 0 };
  }
}

// ============================================
// EXPORT FOR USE IN API
// ============================================

module.exports = {
  SYSTEM_PROMPTS,
  callClaudeAPI,
  generateTemplateNarrative,
  calculateCost,
  AIUsageTracker
};

// ============================================
// EXAMPLE USAGE IN API ENDPOINT
// ============================================

/*
app.post('/api/ai/refine-narrative', async (req, res) => {
  try {
    const { claimData } = req.body;
    
    // Call AI with proper error handling
    const result = await callClaudeAPI('narrativeRefinement', {
      claimantName: claimData.claimantName,
      defendantName: claimData.defendantName,
      claimAmount: claimData.claimAmount,
      claimType: claimData.claimType,
      rawDescription: claimData.rawDescription,
      evidenceList: claimData.evidenceList
    });
    
    if (result.success) {
      // Track usage
      await usageTracker.track(result.usage);
      
      res.json({
        refinedNarrative: result.output,
        cost: result.usage.estimatedCost.myr
      });
    } else {
      // Use fallback template
      res.json({
        refinedNarrative: result.fallback,
        note: 'Generated using template due to API error',
        error: result.error
      });
    }
    
  } catch (error) {
    res.status(500).json({ error: 'Refinement failed' });
  }
});
*/